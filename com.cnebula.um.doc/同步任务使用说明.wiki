=同步任务使用说明=
{{image/calis.png}}\\

**中国高等教育文献保障系统（CALIS）管理中心\\**
**Administrative Center for China Academic Library & Information System\\**
**版本：V3.0**
----

#toc

==1:名词解释==
* **同步任务**：一个同步任务为一个在指定运行时间段内，以指定运行时间间隔来多次运行的程序（同步任务程序）。
它把其他系统的用户数据同步到本系统中来。
例如：运行时间段为：05：00--07：00，指定运行时间间隔为：3600秒，现在时间为01：00.
则同步任务程序会在05：00，06：00，07：00运行，共三次。
* **同步任务程序**：具体执行把其他系统的用户数据同步到本系统的程序（系统进程），它在同步任务中以指定时间间隔来运行。
* **文件数据源同步任务**：是指需要同步的用户数据的载体为文件，但该文件的命名、格式和存放位置是要符合规范的，具体规范详见[[附录3:文件格式规范]]
* **任务日志**：是指在同步任务运行的过程中所产生的信息，通过它，可以了解一个同步任务的运行状态及结果。
* **新建同步任务**：是指在服务器端建立一个同步任务。
* **密码策略**：是指用哪些信息作为为密码，默认为原始密码，即：用户所在原有系统中使用的密码。
* **密码方案**：本系统一共支持4种密码方案，第一种是原始密码，即使用用户在原有系统中的密码，但必须为明文；
第二种是使用证件号码的后六位作为密码；第三种是使用姓名+生日作为密码；
第四种是使用邮箱找回密码。密码方案可由管理员在创建同步任务时指定。
* **默认有效期（月）**：如果在用户数据中，没有指定该用户的有效截止日期，则该用户的有效截止日期为该用户在本系统的创建时间+默认有效期。
例如：创建时间为2009年2月3日，默认有效期为12，则该用户的有效截止日期为2010年2月3日。
* **更新同步任务**：改变一个已经存在的同步任务的配置信息，如果该任务的同步任务程序正在运行，则无法保存，请等待其运行完毕或则强制停止后，方可保存。可改变的配置信息如：运行时间段、是否启用等。
* **删除同步任务**：删除一个已经存在的同步任务，相应的任务日志也将被删除。但不删除该任务的数据源数据（文本文件）、已经同步的用户数据，如果该任务的同步任务程序正在运行，则无法删除，请等待其运行完毕或则强制停止后，方可删除。
* **开始同步任务**：在同步任务程序下次运行之前，马上运行一次同步任务程序。如果该任务的同步任务程序正在运行，则无法开始，请等待其运行完毕或则强制停止后，方可开始。
* **停止同步任务**：停止一个同步任务，使其在下次服务端重启之前不在运行。如果该任务的同步任务程序正在运行，则无法停止，请等待其运行完毕或则强制停止后，方可停止。
如想在服务端重启之后，该任务也不运行，则应停用该任务（参考更新同步任务），或删除该任务。
* **重启同步任务**：即先停止，再开始。
* **强制停止同步任务**：是停止同步任务的增强功能，即：即使同步任务程序正在运行，也能将其强制停止.\\
||{{image/warning.png |warning.png}}**强制停止并不保证用户数据的一致性和正确性，请慎用之！**\\||


==2:同步任务使用方法==
===2.1文件数据源同步任务===
登陆管理端以后，选择左侧树形目录中的“数据同步管理器”节点下的“文件数据源同步任务”菜单，\\
就会打开“文件数据源同步任务”窗口,如图：\\
{{image/DataSynForm.bmp |DataSynForm.bmp}}\\
工具栏上的按钮与显示数据中的表格右键菜单功能一致\\
{{image/DataSynContextMenu.bmp |DataSynContextMenu.bmp}}\\
具体菜单内容含义请参加名词解释[[1:名词解释]]

====2.1.1新建同步任务====
选择工具栏上的按钮{{image/add.bmp}}或者选择右键菜单{{image/radd.bmp}}，即可打开新建任务窗口\\
{{image/new.jpg}}\\填写好各项内容保存以后，就完成了一个同步任务的创建。

====2.1.3更新同步任务====
鼠标双击下面任务列表中的一条记录，即可打开任务修改窗口\\
{{image/update.jpg}}\\,修改以后点击保存按钮即可。

====2.1.3删除同步任务====
选中任务列表中的一条数据，点击工具栏中的删除按钮{{image/delete.bmp}}或者右键菜单的{{image/rdelete.bmp}}即可。

====2.1.4开始同步任务====
选中任务列表中的一条数据，点击工具栏中的开始{{image/start.bmp}}或者右键菜单的{{image/rstart.bmp}}

====2.1.5停止同步任务====
选中任务列表中的一条数据，点击工具栏中的开始{{image/stop.bmp}}或者右键菜单的{{image/rstop.bmp}}

====2.1.6重启同步任务====
选中任务列表中的一条数据，点击工具栏中的开始{{image/restart.bmp}}或者右键菜单的{{image/rrestart.bmp}}

====2.1.7强制停止同步任务====
选中任务列表中的一条数据，点击工具栏中的开始{{image/forcestop.bmp}}或者右键菜单的{{image/rforcestop.bmp}}

====2.1.8任务日志====
登陆管理端以后，选择左侧树形目录中的“数据同步管理器”节点下的“任务日志”菜单，\\
就会打开“任务日志”窗口,如图：\\
{{image/tasklog.jpg}}\\
双击日志列表中的一条日志，就会显示出这条日志的详细内容\\
如果日志过多，则可以在窗口上部的查询区域输入查询条件，查询需要的日志，如图：\\
{{image/searchlog.jpg}}\\


==3:附录：文件格式规范==
===3.1文件夹结构规则===
这里的文件夹特指用于存放同步数据的文件夹，用于把该文件夹下的相关文件中的数据\\
同步到本系统中。该文件夹下设若干个子文件夹分别对应各个馆数据，文件夹的名字为馆代码！\\
每个馆文件夹下又可以有若干个自己馆的子文件夹。\\
例如：有两个馆需要同步，一个为北京大学，馆代码为：pku,有2个任务子目录，分别是subFolder1和subFolder2,\\
一个为清华大学,馆代码为：tsinghua,有一个子目录subFolder，根文件夹为Datasyn,则相应的目录结构如下所示:\\
||{{image/folder.bmp |folder}}\\||

===3.2文件规则===
文件格式为TXT，编码为UTF-8，文件名必须是“${orgcode}@${date}”，其中${orgcode}\\
是馆代码，${date}是该文件中记录的时间戳最大值,否则将会导致系统的时间戳大于文件的时间戳的错误。\\
单个文件的大小上限为2GB,大于2GB不予导入\\
例如：北京大学,要导入的数据为2009年十月十日十时十分十秒之前创建或更新的用户。\\
文件名为：pku@20091010101010.txt\\

===3.3数据格式===
1.      数据项
每一行一条记录， 各列以TAB键（"\t"）分隔，没有数据的列用 "null"填充,如不符合规范，将不予导入。依次的列为：\\
*登录密码   \\
可以为空（null）。如果密码为加密密码或不使用原始密码方案。
*校园卡/图书证号  \\
不能为空（null）。否则该条记录不能导入。\\
注意：在一个馆内，请确保校园卡/图书证号的唯一性。
*证件号码\\
可以为空（null）。但如要使用第二种密码方案（即证件号码后六位做为密码），此处不能为空（null）。\\
注意：在一个馆内，请确保证件号码的唯一性。
*证件类型\\
可以为空（null）。但如果证件号码不为空，则此处不能为空（null）。\\
取值必须是数字，预置的类型如下：
|=含义|=类型值|
|身份证号|1|
|士官证号|2|
|护照号|3|
|工作证号|4|
|其他号码|6|
如需新增类型，请找到配置文件夹（conf目录）下的es-i18n下的umentity-uas.xml,找到\\
{{code language="xml"}}	
<singleNamespace
		namespace="com.cnebula.um.ejb.entity.usr.idCardType">
		<item key="1" defaultLang="zh_CN">
			<locale value="ID Card(1)" lang="en_US" />
			<locale value="身份证号(1)" lang="zh_CN" />
		</item>
	
		<item key="2" defaultLang="zh_CN">
			<locale value="Officer Card(2)" lang="en_US" />
			<locale value="士官证号(2)" lang="zh_CN" />
		</item>

		<item key="3" defaultLang="zh_CN">
			<locale value="Passport(3)" lang="en_US" />
			<locale value="护照号(3)" lang="zh_CN" />
		</item>
		<item key="4" defaultLang="zh_CN">
			<locale value="Employee's Card(4)" lang="en_US" />
			<locale value="工作证号(4)" lang="zh_CN" />
		</item>
		<item key="6" defaultLang="zh_CN">
			<locale value="Other ID(6)" lang="en_US" />
			<locale value="其他号码(6)" lang="zh_CN" />
		</item>
	</singleNamespace>
{{/code}} 
		配置项,其中的"6"为类型值，"其他号码"为含义，请新增并修改为相应数据。\\
		注意：类型值必须为500以上！
*证件号验证标识  \\
可以为空（null）。但如果证件号码不为空，则此处不能为空（null），取值为true 或 false。\\

**只能在 证件号码、证件类型和证件验证标识 都不为空的情况下才能导入证件号码**\\

*邮箱\\
可以为空（null）。该用户的电子邮件地址（email）,但如要使用第四种密码方案（即使用邮箱找回密码），此处不能为空（null）。\\
注意：在一个馆内，请确保邮箱的唯一性。
*邮箱证验证标识\\
可以为空（null）。但如果邮箱不为空，则此处不能为空（null），则此处取值为true 或 false。\\

**只能在 邮箱和邮箱验证标识 都不为空的情况下才能导入电子邮件**\\

*手机号\\
可以为空（null）。该用户的手机号码（支持GSM网络或３Ｇ网络），可供用户日后登录系统用。
*有效截止日期\\
可以为空（null）。该用户的有效截止日期，格式为"yyyy-MM-dd",例如2012-01-01,表示2012年一月一日\\
如此处为空（null）,则由管理员在同步时指定默认的有效期。则该用户的有效截止日期为该用户的创建日期+默认有效期。
*姓名\\
不能为空（null）。中英文均可。
*性别\\
不能为空（null）。男为"m"，女为"f",必取二者之一。
*所属学院\\
可以为空（null）。
*所属系\\
可以为空（null）。
*所属专业\\
可以为空（null）。
*用户类型\\
不能为空（null）。取值 必须是数字，预置的类型如下：
|=含义|=类型值|
|本科生|1|
|研究生|2|
|博士|3|
|教师|4|
|留学生|5|
|成人教育|6|
|校外读者|7|
|其它|8|
如需新增类型，请找到配置文件夹（conf目录）下的es-i18n下的umentity-uas.xml,找到\\
{{code language="xml"}}	
	<singleNamespace
		namespace="com.cnebula.um.ejb.entity.usr.UMPrincipalUserTypes">
		<item key="1" defaultLang="zh_CN">
			<locale value="Undergraduate(1)" lang="en_US" />
			<locale value="本科生(1)" lang="zh_CN" />
		</item>
		<item key="2" defaultLang="zh_CN">
			<locale value="Master(2)" lang="en_US" />
			<locale value="研究生(2)" lang="zh_CN" />
		</item>
		<item key="3" defaultLang="zh_CN">
			<locale value="Doctor(3)" lang="en_US" />
			<locale value="博士(3)" lang="zh_CN" />
		</item>
		<item key="4" defaultLang="zh_CN">
			<locale value="Teacher(4)" lang="en_US" />
			<locale value="教师(4)" lang="zh_CN" />
		</item>
		<item key="5" defaultLang="zh_CN">
			<locale value="Student Abroad(5)" lang="en_US" />
			<locale value="留学生(5)" lang="zh_CN" />
		</item>
		<item key="6" defaultLang="zh_CN">
			<locale value="Adult Education(6)" lang="en_US" />
			<locale value="成人教育(6)" lang="zh_CN" />
		</item>
		<item key="7" defaultLang="zh_CN">
			<locale value="External reader(7)" lang="en_US" />
			<locale value="校外读者(7)" lang="zh_CN" />
		</item>
		<item key="8" defaultLang="zh_CN">
			<locale value="Others(8)" lang="en_US" />
			<locale value="其它(8)" lang="zh_CN" />
		</item>
	</singleNamespace>
{{/code}} 
		配置项,其中的“8”为类型值，“其他”为含义，请新增并修改为相应数据。\\
		注意：类型值必须为500以上！
		*地址\\
		可以为空（null）。该用户的通讯地址。如：北京大学图书馆。
		*邮编\\
可以为空（null）。
		*本地用户ID\\
		可以为空（null）。用户在原有系统库中记录的ID。
		*最后修改时间戳\\
		可以为空（null）。表示该条记录最后修改的时间，同步程序据此判断是否应更新该条记录，如不提供此信息，则同步程序默认为该条记录所在的文件名中的时间戳。\\
格式为"yyyyMMddhhmmss",例如：20091012121323，表示2009年10月12日12时13分23秒
*生日("birthday")\\
可以为空（null）。格式为"yyyy-MM-dd",例如2009-01-01,表示2009年一月一日\\
但如要使用第三种密码方案（即使用姓名+生日作为密码），此处不能为空（null）。
*用户状态\\
不能为空（null）。必须是数字，预置的类型如下：
|=含义|=类型值|
|待审核|0|
|普通|1|
|合法|2|
|注销|3|
|停用|4|
|无效|5|
*用户名\\
不能为空（null）。在原有系统中的用户名。


===3.4示例===
Pku是北京大学的馆代码
20090809101010表示文件中的时间戳的最大值为：2009年8月9号10点10分10秒.\\
文件路径为：Datasyn\pku\subFolder1 (**注：subFolder1是新建同步任务时指定的子目录**)\\
文件名为：pku@20090809101010.txt\\
文件中的记录为：\\
|123456	|pku0000123|	152301198001012030	|1|	true	|ww@ss.com	|true	|13911112222	|2020-01-01	|zhangsan|	m	|生化	学院|临床系|解剖学|	1	|北京大学生化学院	|010010	|local_111123232|	20071010101010	|1980-01-01|2|loginid1|
|asddff|pku0000564|	152301198111112030	|1|	true	|wf@ss.com	|true	|13910015572	|2020-01-01	|lishi|	m	|计算机学院|计算机|计算机应用技术|	1	|北京大学计算机学院	|010010	|local_1114444|	20071010101010	|1981-11-11|4|loginid2|
第一条记录的含义为：密码是123456，图书证号是：pku0000123，身份证号是：152301198001012030，身份证验证标识为：true，邮箱为
ww@ss.com，邮箱验证标识为：true，手机号是：13911112222，账户有效截止日期为：2020-01-01，性别为：男性，所属学院：生化学院，所属系：
临床系，专业：解刨学，通讯地址：北京大学生化学院，邮编：010010，内部ID：local_111123232，用户最后修改时间戳：20071010101010，生日：1980-01-01，用户状态为合法,用户名为loginid1。
|{{image/data.bmp | data}}||\\
===3.5其他说明===
*导入流程概要\\
# 从库中读取上次同步的记录最新时间戳，记为lastTime（第一次默认为1970年）
# 从文件夹中读取那些文件名中的时间戳大于lastTime的文本文件，记为txts
# 对txts中的每一条记录，进行合法性检查，如不符合规范，则不予导入
# 对txts中的每一条记录，如果库中没有，则新建，如果该条记录的时间戳大于lastTime，则更新
# 更新lastTime为所有记录中的时间戳最大值（包括文本文件名中的时间戳），并入库lastTime

*关于日志\\
由于日志会不断的增加，因此，数据库系统管理员应该定期删除库中的日志数据，删除日志的SQL语句参考如下：\\
{{code}}
delete from um_syn_task_log g where g.id not in(
       select max(l.id)　from um_syn_task_log l where l.lasttimestamp in (
              select max(t.lasttimestamp) from um_syn_task_log t group by t.task_id
       )
       group by l.task_id
)
{{/code}}

*其他说明\\
# 时间戳必须在系统当前时间戳和最后更新时间戳之间
# 任务运行的时间间隔最小为3600秒，即一个小时
# 如果在同步任务程序正在运行过程中加入了新的数据源（txt文本）,则有可能导入不成功，请查看日志获取详情（查看文件名和文件大小是否和实际相符合）
# 校园卡/图书证号用于关联该用户在本地的记录和该用户在原有系统的记录，因此卡号不可更新。
# 密码没有位数限制，但建议至少为6位，以方便其在管理端的管理
# 同步后的用户所在机构为该用户所在单位的顶级机构，如该机构不存在（即该机构不存在于本系统内），则用户所在机构为空
# 新建同步任务时，留意密码方案的选择，这可能会影响到用户的登陆
# 证件号更新依据为证件类型，即类型相同就认为是同一条记录
# 证件号不能为邮箱或则手机号，如要想同步邮箱或则手机号，请在适当位置添加，请参考[[3.3数据格式]]
# 强制停止或由于其他原因导致本次同步没有正常结束，则程序会在下次重新运行本次任务，直至正常结束。